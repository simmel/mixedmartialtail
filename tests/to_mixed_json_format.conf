input {
  stdin {}
}

filter {
  # Make the percentage of JSON logs controllable via an environment variable
  environment {
    add_metadata_from_env => {
      "percentage" => "PERCENTAGE"
    }
  }

  ruby {
    code => "
      if rand <= (event['@metadata']['percentage']).to_f/100
        (event['tags'] ||= []) << 'json'
      end
    "
  }

  if "json" in [tags] {

    grok {
      match => {
        "message" => "%{COMBINEDAPACHELOG}"
      }
    }

    mutate {
      remove_field => [
        "@timestamp",
        "@version",
        "host",
        "message",
        "tags"
      ]
    }
  }
}

output {
  # If this field exists, it's JSON
  if [clientip] {
    stdout {
      codec => json_lines
    }
  }
  else {
    stdout {
      codec => line {
        format => "%{message}"
      }
    }
  }
}
